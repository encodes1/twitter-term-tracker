#!/usr/bin/env node

var OAuth = require('oauth').OAuth,
    events = require('events')
    querystring = require('querystring');

exports.connect = function(options){
//    validateOptions(options);

    var query = querystring.parse(options.params);

    var emitter = new events.EventEmitter;

    var twitter_oauth = new OAuth(
        "https://api.twitter.com/oauth/request_token",
        "https://api.twitter.com/oauth/access_token",
        options.keys.consumer,
        options.keys.consumer_secret,
        "1.0A",
        null,
        "HMAC-SHA1"
    );

    var request = twitter_oauth.get(
        'https://stream.twitter.com/1.1/statuses/' + options.action + '.json?' + query,
//        'https://stream.twitter.com/1.1/statuses/sample.json',
        options.keys.access_token,
        options.keys.access_token_secret
    );

    var message;

    request.on('response', function (response) {
        response.setEncoding('utf8');

        // Check we got a good response
        if (response.statusCode !== 200) {
            var error = String(response.statusCode);
            emitter.emit('error', error);
            return;
        }

        // On response get individual tweets and emit them
        response.on('data', function (chunk) {
            message += chunk;
            var newline_index = message.indexOf('\r');
            if (newline_index !== -1) {
                var tweet_payload = message.slice(0, newline_index);
                var tweet = JSON.parse(tweet_payload);

                if (tweet.text) {
                    emitter.emit('tweet', tweet);
                } else {
                    // Not a tweet, maybe a delete
                    if(tweet.delete){
                        emitter.emit('delete', tweet);
                    }
                }
            }

            message = message.slice(newline_index + 1);
        });


        response.on('end', function () {
            emitter.emit('end');
        });
    });

    request.end();

    return emitter;
};


    consumer_key = 'GnB0DXhhkonUwDeG9Ardkw',
    consumer_secret = 'iwWsFZeg9ncdWl3KjDy1X9mnw1uioN6ZFUx8loK68',
    access_token_key = '488320252-o4VOIiikbvtVF7HyFD7Zb4rLJPHRD7JAre52symJ',
    access_token_secret = 'h95Hb2yqO0ciTIgmp7778MjojOPvVgHo7Ht6YD9nvWTAZ',
    twitter_oauth = new OAuth(
        "https://api.twitter.com/oauth/request_token",
        "https://api.twitter.com/oauth/access_token",
        consumer_key,
        consumer_secret,
        "1.0A",
        null,
        "HMAC-SHA1"
    ),
    message = '',
    request = twitter_oauth.get(
        'https://stream.twitter.com/1.1/statuses/filter.json?track=pizza',
//        'https://stream.twitter.com/1.1/statuses/sample.json',
        access_token_key,
        access_token_secret
    );

request.on('response', function (response) {
    response.setEncoding('utf8');
    response.on('data', function (chunk) {
        message += chunk;
        var newline_index = message.indexOf('\r');
        if (newline_index !== -1) {
            var tweet_payload = message.slice(0, newline_index);
            var tweet = JSON.parse(tweet_payload);

            if (tweet.text) {
                console.log("@" + tweet.user.screen_name + ": " + tweet.text);
            } else {
                // Not a tweet, maybe a delete
                if(tweet.delete){
                    // Do delete logic
                    console.log('Delete status with ID: ' + tweet.delete.status.id.toString());
                }
            }
        }

        message = message.slice(newline_index + 1);
    });


    response.on('end', function () {
        console.log('--- END ---');
    });
});

request.end();
